# Логика работы A/B тестирования промптов

Документ описывает только логику распределения пользователей по группам A и B, без привязки к коду.

---

## Цель

Разным пользователям показываются разные варианты промпта (A или B), чтобы потом сравнить эффективность вариантов. При этом важно:

- один и тот же пользователь всегда попадает в одну и ту же группу;
- распределение не зависит от того, на каком сервере обрабатывается запрос.

---

## Входные данные для определения группы

При определении группы учитываются только два параметра:

1. **Идентификатор пользователя (uid)** — уникальный числовой ID в системе.
2. **Название теста** — строка, однозначно задающая эксперимент (например, `dezhurka_tg_prompt`).

Номер сервера (node_server), логин, время запроса и любые другие данные в расчёт группы **не входят**.

---

## Как пользователь попадает в группу A или B

1. По паре «uid + название теста» вычисляется **одно и то же** значение (детерминированный хеш). То есть для одного и того же пользователя и одного и того же теста результат всегда одинаковый.

2. Это значение приводится к числу в диапазоне от 0 до 1 (равномерное распределение).

3. Задаётся **порог (split ratio)** — доля пользователей, которые должны попасть в вариант A (например, 0,5 = 50%).

4. Правило:
   - если полученное число **меньше** порога — пользователь попадает в **вариант A**;
   - иначе — в **вариант B**.

Итог: для каждого uid и названия теста группа (A или B) определяется однозначно и не меняется со временем и при смене сервера.

---

## Почему один пользователь всегда в одной группе

- Результат зависит только от uid и названия теста.
- Алгоритм один и тот же на всех серверах и при любом количестве запросов.
- Поэтому один и тот же пользователь в одном и том же тесте всегда получает один и тот же вариант (A или B).

---

## Почему разные сервера не влияют

- Номер сервера (node_server) **не используется** при вычислении группы.
- На любом сервере для одних и тех же uid и названия теста получается один и тот же хеш и одно и то же число от 0 до 1.
- Значит, пользователь, который на одном сервере попал в A, на другом сервере тоже будет в A (и то же для B).

Распределение по серверам (кто на каком сервере физически обрабатывается) на принадлежность к группе A/B не влияет.

---

## Что задаёт соотношение A и B (split ratio)

- **Split ratio** — это доля пользователей, которых мы хотим отнести к варианту A (остальные — к B).
- Примеры:
  - 0,5 — примерно половина в A, половина в B (50/50);
  - 0,3 — примерно 30% в A, 70% в B;
  - 0,7 — примерно 70% в A, 30% в B.

Фактическое соотношение в базе может немного отличаться от заданного из‑за случайности хеша, но при большом числе пользователей будет близко к заданному.

---

## Влияет ли вид uid на распределение

- В расчёт попадает **строка**, составленная из uid и названия теста, а не «чётность» или другие свойства числа uid.
- Хеш от такой строки даёт равномерное распределение: нет перекоса в сторону A или B из‑за того, что uid чётные, нечётные или с каким-то паттерном.
- Итог: вид uid (чётность, диапазон и т.п.) на то, в какую группу попадёт пользователь, не влияет.

---

## Когда пользователь «появляется» в тесте

- Группа (A или B) определяется в момент **первого** запроса, где для данного пользователя запрашивается промпт с A/B тестом.
- После этого при каждом следующем запросе тот же пользователь получает тот же вариант; повторного «розыгрыша» нет.

---

## Зачем сохранять назначения в БД

- В базе фиксируется: какой пользователь (uid), в каком тесте (test_name) и в какую группу (A или B) попал; при необходимости сохраняется и номер сервера (node_server) на момент записи.
- Это нужно для:
  - просмотра и анализа распределения (сколько в A и B всего и по серверам);
  - проверки, что соотношение A/B близко к заданному;
  - понимания, какой пользователь в какой группе состоит (в т.ч. через интерфейс и отчёты).

Сохранение в БД не меняет логику определения группы: группа по-прежнему считается только по uid и названию теста; в БД просто записывается результат.

---

## Несколько тестов одновременно

- У одного пользователя может быть своя группа для каждого теста: для теста «X» он в A, для теста «Y» — в B.
- Это обеспечивается за счёт того, что в расчёт входит **название теста**: одна и та же пара (uid, тест) всегда даёт одну группу, разные тесты — независимые «розыгрыши».

---

## Кратко

- Группа (A или B) определяется **только** по uid и названию теста.
- Один пользователь в одном тесте всегда в одной группе, на любом сервере и при любом количестве запросов.
- Соотношение A/B задаётся параметром split ratio (доля в A).
- Сервер, время и свойства uid (например, чётность) на группу не влияют.
- Результат фиксируется в БД для аналитики и отображения в интерфейсе.
